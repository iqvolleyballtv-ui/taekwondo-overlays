<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>VB Score Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{
      margin:0;
      padding:24px;
      background:#020617;
      color:#e5e7eb;
    }
    h1{
      margin:0 0 16px;
      font-size:22px;
    }
    .card{
      background:#020617;
      border-radius:16px;
      border:1px solid #111827;
      padding:16px 20px 20px;
      max-width:780px;
      box-shadow:0 18px 50px #000c;
    }
    label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:#9ca3af;
      display:block;
      margin-bottom:4px;
    }
    input, select{
      width:100%;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      padding:8px 10px;
      font-size:14px;
    }
    input:focus, select:focus{
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .row{
      display:flex;
      gap:12px;
      margin-bottom:10px;
    }
    .row > div{
      flex:1;
    }
    button{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
    }
    .btn-primary{
      background:#0ea5e9;
      color:#0b1120;
    }
    .btn-danger{
      background:#ef4444;
      color:#0b1120;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid #1f2937;
      color:#e5e7eb;
    }
    .section-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:#9ca3af;
      margin:18px 0 6px;
    }
    .score-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
    }
    .score-row span{
      font-size:13px;
      min-width:60px;
    }
    .score-box{
      min-width:46px;
      text-align:center;
      font-size:18px;
      font-weight:800;
    }
    .status{
      margin-top:10px;
      font-size:12px;
      color:#9ca3af;
    }
    .pill-toggle{
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    .pill-toggle button{
      border-radius:999px;
      padding:5px 10px;
      font-size:11px;
    }
    .pill-toggle button.active{
      background:#facc15;
      color:#111827;
    }
  </style>
</head>
<body>
  <h1>Volleyball Scoreboard – Control</h1>

  <div class="card">
    <div class="row">
      <div style="flex:0.7">
        <label>Room</label>
        <input id="roomInput" value="vb1" />
      </div>
      <div style="flex:1.3">
        <label>Match title</label>
        <input id="matchTitle" placeholder="Bronze Medal Match · LAI" />
      </div>
      <div style="flex:0.7;display:flex;align-items:flex-end;gap:8px;">
        <button id="connectBtn" class="btn-primary" style="flex:1;">Connect</button>
        <button id="resetBtn" class="btn-ghost" style="flex:0.8;">Reset</button>
      </div>
    </div>

    <div class="section-title">Equipo A</div>
    <div class="row">
      <div>
        <label>Nombre corto (ITA)</label>
        <input id="aShort" value="A" />
      </div>
      <div>
        <label>Nombre completo</label>
        <input id="aName" value="Team A" />
      </div>
      <div>
        <label>Logo (URL)</label>
        <input id="aLogo" placeholder="https://..." />
      </div>
      <div style="flex:0.5">
        <label>Sets ganados</label>
        <input id="aSets" type="number" value="0" />
      </div>
    </div>

    <div class="section-title">Equipo B</div>
    <div class="row">
      <div>
        <label>Nombre corto (USA)</label>
        <input id="bShort" value="B" />
      </div>
      <div>
        <label>Nombre completo</label>
        <input id="bName" value="Team B" />
      </div>
      <div>
        <label>Logo (URL)</label>
        <input id="bLogo" placeholder="https://..." />
      </div>
      <div style="flex:0.5">
        <label>Sets ganados</label>
        <input id="bSets" type="number" value="0" />
      </div>
    </div>

    <div class="section-title">Marcador actual</div>
    <div class="score-row">
      <span>A</span>
      <button id="aMinus" class="btn-ghost">-</button>
      <div id="aScore" class="score-box">0</div>
      <button id="aPlus" class="btn-primary">+</button>
      <span style="margin-left:8px;">Serve</span>
      <button id="serveA" class="btn-ghost">A</button>
    </div>
    <div class="score-row">
      <span>B</span>
      <button id="bMinus" class="btn-ghost">-</button>
      <div id="bScore" class="score-box">0</div>
      <button id="bPlus" class="btn-primary">+</button>
      <span style="margin-left:8px;">Serve</span>
      <button id="serveB" class="btn-ghost">B</button>
    </div>

    <div class="section-title">Highlight</div>
    <div class="pill-toggle">
      <button data-hl="none"   class="btn-ghost active">Normal</button>
      <button data-hl="setA"   class="btn-ghost">Set point A</button>
      <button data-hl="setB"   class="btn-ghost">Set point B</button>
      <button data-hl="matchA" class="btn-ghost">Match point A</button>
      <button data-hl="matchB" class="btn-ghost">Match point B</button>
    </div>

    <div class="section-title">Vista</div>
    <div class="pill-toggle">
      <button id="liveViewBtn" class="btn-ghost active">Marcador</button>
      <button id="summaryViewBtn" class="btn-ghost">Resumen sets</button>
    </div>

    <div class="status" id="status">Sin conectar.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8r0rLCLLPJx3DsNGMuvVtFuwCMBXrR9M",
      authDomain: "tkd-overlay.firebaseapp.com",
      databaseURL: "https://tkd-overlay-default-rtdb.firebaseio.com",
      projectId: "tkd-overlay",
      storageBucket: "tkd-overlay.firebasestorage.app",
      messagingSenderId: "41501920835",
      appId: "1:41501920835:web:4ccecdf129cf20619d8ef6",
      measurementId: "G-CXBJCL86EM"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const $ = id => document.getElementById(id);

    // Inputs
    const roomInput = $("roomInput");
    const matchTitle = $("matchTitle");

    const aShort = $("aShort");
    const aName  = $("aName");
    const aLogo  = $("aLogo");
    const aSets  = $("aSets");

    const bShort = $("bShort");
    const bName  = $("bName");
    const bLogo  = $("bLogo");
    const bSets  = $("bSets");

    const aScoreBox = $("aScore");
    const bScoreBox = $("bScore");
    const statusEl  = $("status");

    // Botones
    const connectBtn = $("connectBtn");
    const resetBtn   = $("resetBtn");
    const aPlus      = $("aPlus");
    const aMinus     = $("aMinus");
    const bPlus      = $("bPlus");
    const bMinus     = $("bMinus");
    const serveA     = $("serveA");
    const serveB     = $("serveB");
    const liveViewBtn    = $("liveViewBtn");
    const summaryViewBtn = $("summaryViewBtn");

    let highlight = "none";
    let showSummary = false;
    let serving = "A";
    let scoreA = 0;
    let scoreB = 0;
    let stateRef = null;

    function updateLocalUI(){
      aScoreBox.textContent = scoreA;
      bScoreBox.textContent = scoreB;
      serveA.classList.toggle("btn-primary", serving==="A");
      serveB.classList.toggle("btn-primary", serving==="B");
    }

    function buildState(){
      return {
        matchTitle: matchTitle.value || "",
        highlight,
        showSummary,
        serving,
        teamA:{
          short:aShort.value || "A",
          name:aName.value || "Team A",
          logo:aLogo.value || ""
        },
        teamB:{
          short:bShort.value || "B",
          name:bName.value || "Team B",
          logo:bLogo.value || ""
        },
        setsWonA: parseInt(aSets.value||"0",10),
        setsWonB: parseInt(bSets.value||"0",10),
        scoreA,
        scoreB,
        setScores: [] // para futuro
      };
    }

    async function pushState(){
      if(!stateRef) return;
      const data = buildState();
      await set(stateRef, data);
    }

    connectBtn.addEventListener("click", async ()=>{
      const room = (roomInput.value || "vb1").trim();
      stateRef = ref(db, `vb/${room}/state`);
      statusEl.textContent = `Conectando a room "${room}"...`;

      // intenta leer estado existente
      const snap = await get(stateRef);
      if(snap.exists()){
        const s = snap.val();
        scoreA = s.scoreA || 0;
        scoreB = s.scoreB || 0;
        serving = s.serving || "A";
        highlight = s.highlight || "none";
        showSummary = !!s.showSummary;

        aShort.value = s.teamA?.short || aShort.value;
        aName.value  = s.teamA?.name  || aName.value;
        aLogo.value  = s.teamA?.logo  || aLogo.value;
        bShort.value = s.teamB?.short || bShort.value;
        bName.value  = s.teamB?.name  || bName.value;
        bLogo.value  = s.teamB?.logo  || bLogo.value;
        aSets.value  = s.setsWonA ?? aSets.value;
        bSets.value  = s.setsWonB ?? bSets.value;
        matchTitle.value = s.matchTitle || matchTitle.value;
      } else {
        // escribe estado inicial
        await pushState();
      }

      updateLocalUI();
      statusEl.textContent = `Conectado a room "${room}". URL overlay: ?room=${room}`;
    });

    resetBtn.addEventListener("click", ()=>{
      scoreA = 0; scoreB = 0;
      highlight = "none";
      showSummary = false;
      serving = "A";
      updateLocalUI();
      pushState();
    });

    aPlus.addEventListener("click", ()=>{ scoreA++; updateLocalUI(); pushState(); });
    aMinus.addEventListener("click", ()=>{ scoreA = Math.max(0,scoreA-1); updateLocalUI(); pushState(); });
    bPlus.addEventListener("click", ()=>{ scoreB++; updateLocalUI(); pushState(); });
    bMinus.addEventListener("click", ()=>{ scoreB = Math.max(0,scoreB-1); updateLocalUI(); pushState(); });

    serveA.addEventListener("click", ()=>{ serving="A"; updateLocalUI(); pushState(); });
    serveB.addEventListener("click", ()=>{ serving="B"; updateLocalUI(); pushState(); });

    // toggles highlight
    document.querySelectorAll(".pill-toggle button[data-hl]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".pill-toggle button[data-hl]").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        highlight = btn.dataset.hl;
        pushState();
      });
    });

    liveViewBtn.addEventListener("click", ()=>{
      showSummary = false;
      liveViewBtn.classList.add("active");
      summaryViewBtn.classList.remove("active");
      pushState();
    });
    summaryViewBtn.addEventListener("click", ()=>{
      showSummary = true;
      summaryViewBtn.classList.add("active");
      liveViewBtn.classList.remove("active");
      pushState();
    });

    // Si viene ?room= en la URL, úsalo
    const url = new URL(location.href);
    const initialRoom = url.searchParams.get("room");
    if(initialRoom){
      roomInput.value = initialRoom;
    }
  </script>
</body>
</html>
