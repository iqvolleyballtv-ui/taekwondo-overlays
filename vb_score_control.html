<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Volleyball Scoreboard â€“ Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050812;
      --panel: #0b101f;
      --panel-alt: #121828;
      --accent: #ffd54a;
      --accent-soft: #ffec9c22;
      --text-main: #f5f6fb;
      --text-muted: #8590b3;
      --danger: #ff4b6b;
      --good: #3dd68c;
      --border: #1b2236;
      --btn-bg: #151b2b;
      --btn-bg-active: #1e2638;
      --btn-pill: 999px;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        Roboto, sans-serif;
    }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #151c33 0, #050812 55%);
      color: var(--text-main);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      letter-spacing: 0.04em;
    }
    .card {
      max-width: 900px;
      margin: 0 auto;
      background: linear-gradient(145deg, #0b101f, #060815);
      border-radius: 18px;
      padding: 20px 22px 18px;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.65);
      border: 1px solid var(--border);
    }
    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .col {
      flex: 1;
      min-width: 160px;
    }
    label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050813;
      color: var(--text-main);
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
    }
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: #4b9dff;
      box-shadow: 0 0 0 1px #214573;
    }
    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .topbar .grow {
      flex: 1;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px 6px;
      border-radius: 999px;
      background: var(--panel-alt);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }
    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #27e86c;
      box-shadow: 0 0 0 4px #27e86c22;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 8px 18px;
      background: var(--btn-bg);
      color: var(--text-main);
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
      border: 1px solid transparent;
    }
    button:hover {
      background: #20273a;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-accent {
      background: var(--accent);
      color: #11121a;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .btn-accent:hover {
      background: #ffe177;
    }
    .btn-ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--text-muted);
    }
    .btn-pill {
      border-radius: var(--btn-pill);
      padding-inline: 16px;
      font-size: 12px;
    }
    .btn-pill.active {
      background: #1e2537;
      border-color: #3b4764;
      color: #fefefe;
    }
    .score-row {
      display: grid;
      grid-template-columns: auto auto auto auto;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    .score-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }
    .score-value {
      font-size: 22px;
      text-align: center;
      min-width: 32px;
    }
    .score-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #13192a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .score-btn:hover {
      background: #222a40;
    }
    .serv-toggle {
      display: inline-flex;
      gap: 6px;
      border-radius: 999px;
      background: #050813;
      border: 1px solid #242b40;
      padding: 2px;
    }
    .serv-toggle button {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: none;
      background: transparent;
      color: var(--text-muted);
    }
    .serv-toggle button.active {
      background: #24e26a22;
      color: var(--good);
    }
    .section-title {
      margin: 10px 0 4px;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }
    .foot {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-ok {
      background: var(--good);
      box-shadow: 0 0 0 4px #3dd68c22;
    }
    .status-bad {
      background: var(--danger);
      box-shadow: 0 0 0 4px #ff4b6b22;
    }
    .file-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    input[type="file"] {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Volleyball Scoreboard â€“ Control</h1>

    <div class="topbar">
      <div class="col" style="max-width: 120px">
        <label>Room</label>
        <input id="room" type="text" value="vb1" />
      </div>
      <div class="grow">
        <label>Match title</label>
        <input
          id="matchTitle"
          type="text"
          value="Bronze Medal Match Â· LAI"
        />
      </div>
      <div>
        <button id="connect" class="btn-accent">Connect</button>
      </div>
      <div>
        <button id="reset" class="btn-ghost">Reset</button>
      </div>
    </div>

    <!-- EQUIPO A -->
    <div class="section-title">Equipo A</div>
    <div class="row">
      <div class="col" style="max-width: 120px">
        <label>Nombre corto (siglas)</label>
        <input id="aShort" type="text" value="ITA" maxlength="4" />
      </div>
      <div class="col">
        <label>Nombre completo</label>
        <input id="aName" type="text" value="Team A" />
      </div>
      <div class="col">
        <label>Logo (URL)</label>
        <input id="aLogoUrl" type="text" placeholder="https://..." />
        <input id="aLogoFile" type="file" accept="image/*" />
        <div class="file-note">Usa archivo o URL (archivo tiene prioridad).</div>
      </div>
      <div class="col" style="max-width: 120px">
        <label>Sets ganados</label>
        <input id="aSets" type="number" min="0" max="5" value="0" />
      </div>
    </div>

    <!-- EQUIPO B -->
    <div class="section-title">Equipo B</div>
    <div class="row">
      <div class="col" style="max-width: 120px">
        <label>Nombre corto (siglas)</label>
        <input id="bShort" type="text" value="USA" maxlength="4" />
      </div>
      <div class="col">
        <label>Nombre completo</label>
        <input id="bName" type="text" value="Team B" />
      </div>
      <div class="col">
        <label>Logo (URL)</label>
        <input id="bLogoUrl" type="text" placeholder="https://..." />
        <input id="bLogoFile" type="file" accept="image/*" />
        <div class="file-note">Usa archivo o URL (archivo tiene prioridad).</div>
      </div>
      <div class="col" style="max-width: 120px">
        <label>Sets ganados</label>
        <input id="bSets" type="number" min="0" max="5" value="0" />
      </div>
    </div>

    <!-- MARCADOR ACTUAL -->
    <div class="section-title">Marcador actual (set en juego)</div>
    <div class="row">
      <div class="col">
        <div class="score-row">
          <div class="score-label">A</div>
          <button class="score-btn" data-score="-1" data-team="A">âˆ’</button>
          <div id="scoreA" class="score-value">0</div>
          <button class="score-btn" data-score="+1" data-team="A">+</button>
        </div>
      </div>
      <div class="col">
        <div class="score-row">
          <div class="score-label">B</div>
          <button class="score-btn" data-score="-1" data-team="B">âˆ’</button>
          <div id="scoreB" class="score-value">0</div>
          <button class="score-btn" data-score="+1" data-team="B">+</button>
        </div>
      </div>
      <div class="col">
        <label>Serve</label>
        <div class="serv-toggle">
          <button type="button" id="serveA" class="active">A</button>
          <button type="button" id="serveB">B</button>
        </div>
      </div>
    </div>

    <!-- HIGHLIGHT -->
    <div class="section-title">Highlight</div>
    <div class="row">
      <div class="col">
        <button class="btn-pill active" data-hl="normal">Normal</button>
        <button class="btn-pill" data-hl="setA">Set point A</button>
        <button class="btn-pill" data-hl="setB">Set point B</button>
        <button class="btn-pill" data-hl="matchA">Match point A</button>
        <button class="btn-pill" data-hl="matchB">Match point B</button>
      </div>
    </div>

    <!-- VISTA -->
    <div class="section-title">Vista</div>
    <div class="row">
      <div class="col">
        <button class="btn-pill active" data-view="score">Marcador</button>
        <button class="btn-pill" data-view="sets">Resumen sets</button>
      </div>
    </div>

    <div class="foot">
      <div id="status">
        <span class="status-dot status-bad"></span>
        Sin conectar.
      </div>
      <div>
        Atajos: + / âˆ’ para sumar/restar puntos luego ðŸ˜‰
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // âš™ï¸ MISMA CONFIG QUE YA USAS EN LOS OTROS OVERLAYS
    const firebaseConfig = {
      apiKey: "AIzaSyDB0r0rLCLpJX3DsNGMuvvTFUwCMBXRPpM",
      authDomain: "tkd-overlay.firebaseapp.com",
      databaseURL: "https://tkd-overlay-default-rtdb.firebaseio.com",
      projectId: "tkd-overlay",
      storageBucket: "tkd-overlay.firebasestorage.app",
      messagingSenderId: "41501920835",
      appId: "1:41501920835:web:4ccecdf129cf20619d8ef6",
      measurementId: "G-CXBJCL86EM",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ----- estado local -----
    let state = {
      room: "vb1",
      matchTitle: "Bronze Medal Match Â· LAI",
      teamA: {
        short: "ITA",
        name: "Team A",
        logoUrl: "",
        logoData: "",
        sets: 0,
        score: 0,
        serves: true,
      },
      teamB: {
        short: "USA",
        name: "Team B",
        logoUrl: "",
        logoData: "",
        sets: 0,
        score: 0,
        serves: false,
      },
      highlight: "normal", // normal | setA | setB | matchA | matchB
      view: "score", // score | sets (mÃ¡s adelante)
    };

    let stateRef = null;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const connectBtn = $("connect");
    const resetBtn = $("reset");

    // helpers
    function updateFromForm() {
      state.room = $("room").value.trim() || "vb1";
      state.matchTitle = $("matchTitle").value || "";

      state.teamA.short = $("aShort").value || "A";
      state.teamA.name = $("aName").value || "";
      state.teamA.logoUrl = $("aLogoUrl").value || "";
      state.teamA.sets = Number($("aSets").value || 0);

      state.teamB.short = $("bShort").value || "B";
      state.teamB.name = $("bName").value || "";
      state.teamB.logoUrl = $("bLogoUrl").value || "";
      state.teamB.sets = Number($("bSets").value || 0);
    }

    function renderScores() {
      $("scoreA").textContent = state.teamA.score;
      $("scoreB").textContent = state.teamB.score;
      $("aSets").value = state.teamA.sets;
      $("bSets").value = state.teamB.sets;

      $("serveA").classList.toggle("active", state.teamA.serves);
      $("serveB").classList.toggle("active", state.teamB.serves);
    }

    function pushState() {
      if (!stateRef) return;
      updateFromForm();
      set(stateRef, state).catch((err) => {
        console.error(err);
        statusEl.innerHTML =
          '<span class="status-dot status-bad"></span>Error enviando al overlay.';
      });
    }

    // logo desde archivo â†’ dataURL
    function wireLogoFile(inputEl, teamKey) {
      inputEl.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          state[teamKey].logoData = reader.result;
          pushState();
        };
        reader.readAsDataURL(file);
      });
    }
    wireLogoFile($("aLogoFile"), "teamA");
    wireLogoFile($("bLogoFile"), "teamB");

    // botones score
    document.querySelectorAll(".score-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const team = btn.dataset.team;
        const delta = btn.dataset.score === "+1" ? 1 : -1;
        if (team === "A") {
          state.teamA.score = Math.max(0, state.teamA.score + delta);
        } else {
          state.teamB.score = Math.max(0, state.teamB.score + delta);
        }
        renderScores();
        pushState();
      });
    });

    // serve
    $("serveA").addEventListener("click", () => {
      state.teamA.serves = true;
      state.teamB.serves = false;
      renderScores();
      pushState();
    });
    $("serveB").addEventListener("click", () => {
      state.teamA.serves = false;
      state.teamB.serves = true;
      renderScores();
      pushState();
    });

    // highlight pills
    document.querySelectorAll("[data-hl]").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll("[data-hl]")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.highlight = btn.dataset.hl;
        pushState();
      });
    });

    // view pills
    document.querySelectorAll("[data-view]").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll("[data-view]")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.view = btn.dataset.view;
        pushState();
      });
    });

    // connect
    connectBtn.addEventListener("click", () => {
      updateFromForm();
      const room = state.room;
      stateRef = ref(db, `vb/${room}/state`);
      statusEl.innerHTML =
        '<span class="status-dot status-ok"></span>Conectando a room "' +
        room +
        '"â€¦';

      // escribir estado inicial
      set(stateRef, state)
        .then(() => {
          statusEl.innerHTML =
            '<span class="status-dot status-ok"></span>Conectado a room "' +
            room +
            '"';
          // opcional: escuchar cambios remotos
          onValue(stateRef, (snap) => {
            if (!snap.exists()) return;
            state = snap.val();
            $("room").value = state.room;
            $("matchTitle").value = state.matchTitle;
            $("aShort").value = state.teamA.short;
            $("aName").value = state.teamA.name;
            $("aLogoUrl").value = state.teamA.logoUrl || "";
            $("aSets").value = state.teamA.sets;
            $("bShort").value = state.teamB.short;
            $("bName").value = state.teamB.name;
            $("bLogoUrl").value = state.teamB.logoUrl || "";
            $("bSets").value = state.teamB.sets;

            document
              .querySelectorAll("[data-hl]")
              .forEach((b) =>
                b.classList.toggle("active", b.dataset.hl === state.highlight),
              );
            document
              .querySelectorAll("[data-view]")
              .forEach((b) =>
                b.classList.toggle("active", b.dataset.view === state.view),
              );

            renderScores();
          });
        })
        .catch((err) => {
          console.error(err);
          statusEl.innerHTML =
            '<span class="status-dot status-bad"></span>Error al conectar.';
        });
    });

    // reset marcador actual (no resetea sets)
    resetBtn.addEventListener("click", () => {
      state.teamA.score = 0;
      state.teamB.score = 0;
      renderScores();
      pushState();
    });

    // estado inicial UI
    renderScores();
  </script>
</body>
</html>
