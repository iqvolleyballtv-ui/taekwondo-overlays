<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Weightlifting Control (LAI)</title>
  <style>
    :root{ --bg:#0b1020; --card:#0f172acc; --text:#F8FAFC; --muted:#9DB2CE; --border:#223055; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px #0006}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,button,select{font-size:14px}
    input[type="text"],input[type="url"],input[type="number"]{background:#0b1220;border:1px solid #26324e;color:#fff;
      padding:8px 10px;border-radius:10px;width:100%}
    button{background:#1F2937;border:1px solid #334155;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    .ok{background:#064e3b;border-color:#065f46}
    .no{background:#7f1d1d;border-color:#991b1b}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <label>Room</label><input id="room" value="wl1" style="max-width:140px"/>
        <label>Sesión</label><input id="sessionName" value="LAI Weightlifting – Plataforma A" style="min-width:260px"/>
        <label>Reloj (seg)</label><input id="clockSec" type="number" min="10" step="5" value="120" style="max-width:120px"/>
        <button id="connect">Connect</button>
        <button id="startStop">Start</button>
        <button id="reset">Reset</button>
        <span class="note">Usa el mismo <b>?room=</b> que en el overlay.</span>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <div class="row"><b>Atleta</b></div>
          <div class="row"><input id="athleteName" placeholder="Nombre del atleta"></div>
          <div class="row"><label>Foto (URL)</label><input id="athletePhoto" type="url" placeholder="https://...jpg/png"></div>
        </div>
        <div>
          <div class="row"><b>Institución</b></div>
          <div class="row"><input id="instName" placeholder="Institución"></div>
          <div class="row"><label>Logo (URL)</label><input id="instLogo" type="url" placeholder="https://...png"></div>
        </div>
      </div>
      <div class="row">
  <label>Foto desde archivo</label>
  <input id="athletePhotoFile" type="file" accept="image/*" style="max-width:260px"/>
  <label>Logo institución desde archivo</label>
  <input id="instLogoFile" type="file" accept="image/*" style="max-width:260px"/>
</div>

      <div class="row" style="margin-top:10px">
        <label>Disciplina</label>
        <select id="discipline"><option>Snatch</option><option>Clean &amp; Jerk</option></select>
        <label>Intento #</label><input id="attemptNo" type="number" min="1" max="3" value="1" style="max-width:80px"/>
        <label>Peso (kg)</label><input id="declaredWeight" type="number" step="1" value="100" style="max-width:120px"/>
        <button id="save">Save / Push</button>
      </div>
      <div class="row">
        <div>Resultado:</div>
        <button class="ok" id="markOk">GOOD LIFT</button>
        <button class="no" id="markNo">NO LIFT</button>
        <button id="clearRes">Borrar</button>
        <div class="note">Los circulitos de intento se llenan automáticamente.</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="note">Atajos: <b>Espacio</b> start/stop, <b>R</b> reset, <b>O</b> OK, <b>N</b> NO, <b>1/2/3</b> intento.</div>
      </div>
    </div>
  </div>

  <script>
    let state = {
      room:'wl1',
      sessionName:'LAI Weightlifting – Plataforma A',
      clockMs:120000, running:false, startedAt:null,
      athleteName:'', athletePhoto:'', instName:'', instLogo:'',
      discipline:'Snatch', attemptNo:1, declaredWeight:100,
      attempts:[null,null,null],
      result:null
    };

    const $=s=>document.querySelector(s);
    const read=()=>{
  state.room = $('#room').value.trim()||'wl1';
  state.sessionName = $('#sessionName').value.trim()||'LAI Weightlifting';
  state.discipline = $('#discipline').value;
  state.attemptNo = Math.max(1,Math.min(3,parseInt($('#attemptNo').value||1)));
  state.declaredWeight = parseFloat($('#declaredWeight').value||0);
  state.athleteName = $('#athleteName').value.trim();

  // Si hay URL escrita, la usamos; si está vacío, dejamos lo que ya tenga (base64 de archivo, por ejemplo)
  const urlPhoto = $('#athletePhoto').value.trim();
  if(urlPhoto) state.athletePhoto = urlPhoto;

  state.instName = $('#instName').value.trim();

  const urlLogo = $('#instLogo').value.trim();
  if(urlLogo) state.instLogo = urlLogo;

  const secs = Math.max(1,parseInt($('#clockSec').value||120));
  if(!state.running) state.clockMs = secs*1000;
};

    const syncUI=()=>{
  $('#room').value=state.room;
  $('#sessionName').value=state.sessionName;
  $('#discipline').value=state.discipline;
  $('#attemptNo').value=state.attemptNo;
  $('#declaredWeight').value=state.declaredWeight;
  $('#athleteName').value=state.athleteName;

  // Si la foto viene de archivo (data URL), no llenamos el input con ese string larguísimo
  if(state.athletePhoto && state.athletePhoto.startsWith('data:')){
    $('#athletePhoto').value = '';
    $('#athletePhoto').placeholder = 'Imagen cargada desde archivo';
  }else{
    $('#athletePhoto').value = state.athletePhoto || '';
    $('#athletePhoto').placeholder = 'https://...jpg/png';
  }

  $('#instName').value=state.instName;

  if(state.instLogo && state.instLogo.startsWith('data:')){
    $('#instLogo').value = '';
    $('#instLogo').placeholder = 'Logo cargado desde archivo';
  }else{
    $('#instLogo').value = state.instLogo || '';
    $('#instLogo').placeholder = 'https://...png';
  }

  $('#clockSec').value=Math.max(1,Math.round(state.clockMs/1000));
  $('#startStop').textContent = state.running ? 'Stop' : 'Start';
};

    function publish(){ read(); syncUI(); if(window._push) window._push(state); }

    $('#save').addEventListener('click', publish);

    $('#startStop').addEventListener('click', ()=>{
      if(state.running){
        const elapsed = Date.now()-(state.startedAt||Date.now());
        state.clockMs = Math.max(0,state.clockMs-elapsed);
        state.running=false; state.startedAt=null;
      }else{
        state.running=true; state.startedAt=Date.now();
      }
      publish();
    });
// Subir foto del atleta desde archivo
$('#athletePhotoFile').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    state.athletePhoto = ev.target.result;  // data URL
    syncUI();
    if(window._push) window._push(state);
  };
  reader.readAsDataURL(file);
});

// Subir logo de institución desde archivo
$('#instLogoFile').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    state.instLogo = ev.target.result;  // data URL
    syncUI();
    if(window._push) window._push(state);
  };
  reader.readAsDataURL(file);
});

    $('#reset').addEventListener('click', ()=>{
      read();
      state.running=false;
      state.startedAt=null;
      state.clockMs=parseInt($('#clockSec').value||120)*1000;
      publish();
    });

    $('#markOk').addEventListener('click', ()=>{
      state.result='ok';
      state.attempts[state.attemptNo-1]='ok';
      publish();
    });
    $('#markNo').addEventListener('click', ()=>{
      state.result='no';
      state.attempts[state.attemptNo-1]='no';
      publish();
    });
    $('#clearRes').addEventListener('click', ()=>{
      state.result=null;
      publish();
    });

    document.addEventListener('keydown',(e)=>{
      if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if(e.code==='Space'){ e.preventDefault(); $('#startStop').click(); }
      if(e.key==='r' || e.key==='R') $('#reset').click();
      if(e.key==='o' || e.key==='O') $('#markOk').click();
      if(e.key==='n' || e.key==='N') $('#markNo').click();
      if(['1','2','3'].includes(e.key)){ $('#attemptNo').value=e.key; read(); publish(); }
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8r0rLCLLPJx3DsNGMuvVtFuwCMBXrR9M",
      authDomain: "tkd-overlay.firebaseapp.com",
      databaseURL: "https://tkd-overlay-default-rtdb.firebaseio.com",
      projectId: "tkd-overlay",
      storageBucket: "tkd-overlay.firebasestorage.app",
      messagingSenderId: "41501920835",
      appId: "1:41501920835:web:4ccecdf129cf20619d8ef6",
      measurementId: "G-CXBJCL86EM"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    document.getElementById('connect').addEventListener('click', async ()=>{
      read();
      const stateRef = ref(db, `wl/${state.room}/state`);
      const snap = await get(stateRef);
      if(!snap.exists()){
        await set(stateRef, state);
      }else{
        state = { ...state, ...snap.val() };
      }
      onValue(stateRef, s=>{
        const incoming = s.val();
        if(incoming){ state=incoming; syncUI(); }
      });
      window._push = s => set(stateRef, s);
      syncUI();
    });

    const u=new URL(location.href);
    const rq=u.searchParams.get('room');
    if(rq){
      document.getElementById('room').value=rq;
      document.getElementById('connect').click();
    }
    syncUI();
  </script>
</body>
</html>
