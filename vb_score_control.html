<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Volleyball Scoreboard – Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:#020617;
      color:#e5e7eb;
    }
    .wrap{
      max-width:920px;
      margin:24px auto 40px;
      padding:16px 20px 32px;
      background:#020617;
    }
    h1{
      margin:0 0 16px;
      font-size:22px;
    }
    fieldset{
      border:1px solid #111827;
      border-radius:14px;
      margin-bottom:16px;
      padding:12px 14px 12px;
    }
    legend{
      padding:0 6px;
      font-size:13px;
      text-transform:uppercase;
      color:#9ca3af;
      letter-spacing:.16em;
    }
    label{
      font-size:13px;
      display:block;
      margin-bottom:4px;
    }
    input,select,button{
      font-family:inherit;
      font-size:13px;
    }
    input[type="text"],input[type="number"],select{
      background:#020617;
      border-radius:9px;
      border:1px solid #1f2937;
      padding:6px 9px;
      color:#e5e7eb;
      outline:none;
      width:100%;
      box-sizing:border-box;
    }
    input[type="number"]{
      max-width:80px;
    }
    .row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .col{
      flex:1;
      min-width:150px;
    }
    .buttons{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    button{
      border-radius:999px;
      border:none;
      padding:6px 14px;
      cursor:pointer;
      background:#1d4ed8;
      color:white;
      font-weight:500;
    }
    button.secondary{
      background:#111827;
      color:#e5e7eb;
    }
    button.small{
      padding:4px 10px;
      font-size:12px;
    }
    small{
      color:#9ca3af;
    }
    .status{
      margin-top:4px;
      font-size:12px;
      color:#9ca3af;
    }
    .badge-toggle button{
      background:#111827;
    }
    .badge-toggle button.active{
      background:#facc15;
      color:#111827;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Volleyball Scoreboard – Control</h1>

    <fieldset>
      <legend>Conexión</legend>
      <div class="row">
        <div class="col">
          <label>Room</label>
          <input id="room" type="text" value="vb1" />
        </div>
        <div class="col">
          <label>Match Title</label>
          <input id="matchTitle" type="text" value="Bronze Medal Match · LAI" />
        </div>
        <div class="col" style="flex:0 0 auto;align-self:flex-end;">
          <div class="buttons">
            <button id="connect">Connect</button>
            <button id="reset" class="secondary">Reset</button>
          </div>
        </div>
      </div>
      <div class="status" id="status">Sin conectar.</div>
      <small>Overlay: <code>.../vb_score_overlay.html?room=vb1</code></small>
    </fieldset>

    <fieldset>
      <legend>Equipos</legend>
      <div class="row">
        <div class="col">
          <label>Equipo A – Siglas</label>
          <input id="aShort" type="text" value="UAGM" />
        </div>
        <div class="col">
          <label>Logo A (URL)</label>
          <input id="aLogoUrl" type="text" placeholder="https://...png (opcional)" />
        </div>
        <div class="col">
          <label>Logo A desde archivo</label>
          <input id="aLogoFile" type="file" accept="image/*" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Equipo B – Siglas</label>
          <input id="bShort" type="text" value="UPRRP" />
        </div>
        <div class="col">
          <label>Logo B (URL)</label>
          <input id="bLogoUrl" type="text" placeholder="https://...png (opcional)" />
        </div>
        <div class="col">
          <label>Logo B desde archivo</label>
          <input id="bLogoFile" type="file" accept="image/*" />
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Marcador</legend>
      <div class="row">
        <div class="col">
          <label>Score A</label>
          <input id="aScore" type="number" value="0" min="0" />
          <div class="buttons">
            <button type="button" data-inc="aScore">+1</button>
            <button type="button" data-dec="aScore" class="secondary">-1</button>
          </div>
        </div>
        <div class="col">
          <label>Score B</label>
          <input id="bScore" type="number" value="0" min="0" />
          <div class="buttons">
            <button type="button" data-inc="bScore">+1</button>
            <button type="button" data-dec="bScore" class="secondary">-1</button>
          </div>
        </div>
        <div class="col">
          <label>Sets ganados A</label>
          <input id="aSets" type="number" value="0" min="0" />
        </div>
        <div class="col">
          <label>Sets ganados B</label>
          <input id="bSets" type="number" value="0" min="0" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Sirve</label>
          <div class="buttons">
            <button type="button" class="small secondary" data-serve="A" id="serveA">Serve A</button>
            <button type="button" class="small secondary" data-serve="B" id="serveB">Serve B</button>
          </div>
        </div>
        <div class="col badge-toggle">
          <label>Highlight</label>
          <div class="buttons">
            <button type="button" class="small active" data-hl="none" id="hlNone">Normal</button>
            <button type="button" class="small" data-hl="setA">Set point A</button>
            <button type="button" class="small" data-hl="setB">Set point B</button>
            <button type="button" class="small" data-hl="matchA">Match point A</button>
            <button type="button" class="small" data-hl="matchB">Match point B</button>
          </div>
        </div>
        <div class="col">
          <label>Vista</label>
          <div class="buttons">
            <button type="button" class="small active" data-view="live" id="viewLive">Marcador</button>
            <button type="button" class="small secondary" data-view="summary" id="viewSummary">Resumen sets</button>
          </div>
        </div>
      </div>
    </fieldset>

    <div class="buttons">
      <button id="save">Save / Push</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8r0rLCLLPJx3DsNGMuvVtFuwCMBXrR9M",
      authDomain: "tkd-overlay.firebaseapp.com",
      databaseURL: "https://tkd-overlay-default-rtdb.firebaseio.com",
      projectId: "tkd-overlay",
      storageBucket: "tkd-overlay.firebasestorage.app",
      messagingSenderId: "41501920835",
      appId: "1:41501920835:web:4ccecdf129cf20619d8ef6",
      measurementId: "G-CXBJCL86EM"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const $ = id => document.getElementById(id);
    let stateRef = null;
    let serving = "A";
    let highlight = "none";
    let view = "live";
    let logoA = "";
    let logoB = "";

    const statusEl = $("status");

    function buildState(){
      return {
        matchTitle: $("matchTitle").value.trim() || "Volleyball Match",
        view,
        highlight,
        serving,
        teamA:{
          short: $("aShort").value.trim() || "A",
          logo: logoA || $("aLogoUrl").value.trim() || ""
        },
        teamB:{
          short: $("bShort").value.trim() || "B",
          logo: logoB || $("bLogoUrl").value.trim() || ""
        },
        setsWonA: Number($("aSets").value) || 0,
        setsWonB: Number($("bSets").value) || 0,
        scoreA:   Number($("aScore").value) || 0,
        scoreB:   Number($("bScore").value) || 0
      };
    }

    async function pushState(){
      if(!stateRef){
        alert("Primero dale a Connect.");
        return;
      }
      const state = buildState();
      await set(stateRef, state);
    }

    $("connect").addEventListener("click", ()=>{
      const room = ($("room").value || "vb1").trim();
      stateRef = ref(db, `vb/${room}/state`);
      statusEl.textContent = `Conectado a room "${room}".`;
      pushState();
    });

    $("reset").addEventListener("click", ()=>{
      $("aScore").value = 0;
      $("bScore").value = 0;
      $("aSets").value  = 0;
      $("bSets").value  = 0;
      serving = "A";
      highlight = "none";
      view = "live";
      updateServeButtons();
      updateHighlightButtons();
      updateViewButtons();
      pushState();
    });

    $("save").addEventListener("click", pushState);

    // +1 / -1
    document.body.addEventListener("click",(e)=>{
      const inc = e.target.getAttribute("data-inc");
      const dec = e.target.getAttribute("data-dec");
      const hl = e.target.getAttribute("data-hl");
      const sv = e.target.getAttribute("data-serve");
      const vw = e.target.getAttribute("data-view");

      if(inc){
        const input = $(inc);
        input.value = (Number(input.value)||0)+1;
        pushState();
      }
      if(dec){
        const input = $(dec);
        input.value = Math.max(0,(Number(input.value)||0)-1);
        pushState();
      }
      if(hl){
        highlight = hl;
        updateHighlightButtons();
        pushState();
      }
      if(sv){
        serving = sv;
        updateServeButtons();
        pushState();
      }
      if(vw){
        view = vw;
        updateViewButtons();
        pushState();
      }
    });

    function updateServeButtons(){
      ["serveA","serveB"].forEach(id=>{
        $(id).classList.add("secondary");
      });
      if(serving==="A"){
        $("serveA").classList.remove("secondary");
      }else{
        $("serveB").classList.remove("secondary");
      }
    }

    function updateHighlightButtons(){
      document.querySelectorAll('[data-hl]').forEach(btn=>{
        btn.classList.remove("active");
      });
      const active = document.querySelector(`[data-hl="${highlight}"]`);
      if(active) active.classList.add("active");
    }

    function updateViewButtons(){
      $("viewLive").classList.toggle("active",view==="live");
      $("viewSummary").classList.toggle("active",view==="summary");
    }

    // Cargar logos desde archivo como dataURL
    function handleFile(input, setter){
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        setter(e.target.result); // base64
        pushState();
      };
      reader.readAsDataURL(file);
    }

    $("aLogoFile").addEventListener("change", ()=>handleFile($("aLogoFile"), v=>logoA=v));
    $("bLogoFile").addEventListener("change", ()=>handleFile($("bLogoFile"), v=>logoB=v));

    // Estado inicial de botones
    updateServeButtons();
    updateHighlightButtons();
    updateViewButtons();
  </script>
</body>
</html>
