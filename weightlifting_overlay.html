<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Weightlifting Overlay LAI</title>
  <style>
    :root{
      --bg: transparent;
      --panel-dark:#06141FEE;
      --panel-light:#11A5C8;
      --panel-mid:#093452;
      --text:#F9FAFB;
      --muted:#B0C4D9;
      --accent:#FBBF24;
    }
    html,body{
      margin:0;
      height:100%;
      background:var(--bg);
      font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Arial;
    }
    .root{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    /* ---------------- PRESENTACIÓN (cuando el reloj NO corre) ---------------- */

    .present-wrap{
      position:absolute;
      left:50%;
      bottom:6%;
      transform:translateX(-50%);
      width:80%;
      max-width:1200px;
      color:var(--text);
      transition:opacity .25s ease;
    }

    .present-main{
      display:flex;
      align-items:stretch;
      background:var(--panel-mid);
      border-radius:10px 10px 0 0;
      overflow:hidden;
      box-shadow:0 12px 35px #0009;
    }
    .present-lane{
      width:56px;
      background:#FBBF24;
      color:#081018;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:900;
      font-size:24px;
    }
    .present-body{
      flex:1;
      display:flex;
      align-items:center;
      padding:10px 16px;
      gap:14px;
    }
    .present-flag{
      width:68px;
      height:46px;
      border-radius:6px;
      object-fit:cover;
      background:#0004;
    }
    .present-text{
      flex:1;
      min-width:0;
    }
    .present-inst{
      font-size:18px;
      font-weight:700;
      letter-spacing:.18em;
      color:var(--muted);
      text-transform:uppercase;
    }
    .present-name{
      font-size:28px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .present-logo-box{
      width:90px;
      background:#0B2135;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
    }
    .present-logo{
      max-width:100%;
      max-height:60px;
      object-fit:contain;
      filter:drop-shadow(0 0 6px #0008);
    }

    .present-bottom{
      display:flex;
      background:var(--panel-light);
      border-radius:0 0 10px 10px;
      overflow:hidden;
      font-weight:700;
      font-size:18px;
    }
    .present-cell{
      flex:1;
      padding:8px 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#04212C;
    }
    .present-cell:nth-child(2){
      background:#0F9CBF;
    }
    .present-weight{
      background:#083349;
      color:var(--accent);
      font-size:22px;
      flex:1.2;
    }
    .tag-attempt{
      margin-right:6px;
      font-weight:900;
    }

    /* ---------------- LEVANTAMIENTO (cuando el reloj SÍ corre) ---------------- */

    .live-bar{
      position:absolute;
      left:4%;
      bottom:3%;
      display:flex;
      align-items:center;
      background:var(--panel-dark);
      border-radius:10px;
      padding:8px 14px;
      gap:10px;
      box-shadow:0 12px 30px #000a;
      color:var(--text);
      transition:opacity .25s ease;
    }
    .live-tag{
      padding:4px 10px;
      border-radius:999px;
      background:#0B2135;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .live-weight{
      font-size:30px;
      font-weight:900;
      letter-spacing:.05em;
    }
    .live-disc{
      font-size:18px;
      font-weight:700;
      text-transform:uppercase;
      color:var(--muted);
    }
    .live-name-mini{
      margin-left:10px;
      font-weight:700;
      max-width:260px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Timer + logo abajo derecha */

    .timer-wrap{
      position:absolute;
      right:4%;
      bottom:3%;
      display:flex;
      align-items:center;
      gap:10px;
      transition:opacity .25s ease;
    }
    .timer-box{
      background:#F4F4F5;
      color:#020617;
      border-radius:10px;
      padding:8px 14px;
      font-weight:900;
      font-size:26px;
      min-width:92px;
      text-align:center;
      box-shadow:0 10px 28px #000a;
    }
    .timer-lai{
      background:#022C3A;
      color:var(--text);
      border-radius:10px;
      padding:8px 14px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 28px #000a;
      font-weight:800;
      font-size:16px;
      text-transform:uppercase;
      letter-spacing:.14em;
    }
    .timer-lai img{
      width:34px;
      height:34px;
      object-fit:contain;
      filter:drop-shadow(0 0 6px #0008);
    }
    .timer-lai span{
      white-space:nowrap;
    }

    /* Helpers */

    .hidden{ opacity:0; }
    .visible{ opacity:1; }
  </style>
</head>
<body>
  <div class="root">

    <!-- PRESENTACIÓN DEL ATLETA (cuando el reloj NO corre) -->
    <div id="present" class="present-wrap visible">
      <div class="present-main">
        <div class="present-lane" id="laneBox">UPR</div>
        <div class="present-body">
          <img id="presentFlag" class="present-flag" alt="">
          <div class="present-text">
            <div class="present-inst" id="presentInst">INSTITUCIÓN</div>
            <div class="present-name" id="presentName">Nombre atleta</div>
          </div>
        </div>
        <div class="present-logo-box">
          <img id="presentLogo" class="present-logo" alt="">
        </div>
      </div>
      <div class="present-bottom">
        <div class="present-cell">
          <span class="tag-attempt">ATTEMPT</span>
          <span id="presentAttemptNo">1</span>
        </div>
        <div class="present-cell">
          <span id="presentDiscipline">SNATCH</span>
        </div>
        <div class="present-cell present-weight">
          <span id="presentWeight">100 KG</span>
        </div>
      </div>
    </div>

    <!-- BARRA DURANTE LEVANTAMIENTO (cuando el reloj SÍ corre) -->
    <div id="liveBar" class="live-bar hidden">
      <div class="live-tag" id="liveAttemptTag">ATTEMPT 1</div>
      <div class="live-weight" id="liveWeight">100 KG</div>
      <div class="live-disc" id="liveDisc">SNATCH</div>
      <div class="live-name-mini" id="liveNameMini">Nombre atleta</div>
    </div>

    <!-- Timer + logo evento / institución -->
    <div id="timerArea" class="timer-wrap hidden">
      <div class="timer-box" id="timerBox">02:00</div>
      <div class="timer-lai" id="timerLai">
        <img id="laiLogo" alt="" style="display:none;">
        <span id="laiText">LAI</span>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // MISMA CONFIG DE TKD
    const firebaseConfig = {
      apiKey: "AIzaSyD8r0rLCLLPJx3DsNGMuvVtFuwCMBXrR9M",
      authDomain: "tkd-overlay.firebaseapp.com",
      databaseURL: "https://tkd-overlay-default-rtdb.firebaseio.com",
      projectId: "tkd-overlay",
      storageBucket: "tkd-overlay.firebasestorage.app",
      messagingSenderId: "41501920835",
      appId: "1:41501920835:web:4ccecdf129cf20619d8ef6",
      measurementId: "G-CXBJCL86EM"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const url  = new URL(location.href);
    const room = url.searchParams.get('room') || 'wl1';
    const stateRef = ref(db, `wl/${room}/state`);

    // Logo LAI opcional por URL (?laiLogo=https://...)
    const laiLogoUrl = url.searchParams.get('laiLogo') || null;

    const $ = s => document.querySelector(s);
    const pad = n => String(n).padStart(2,'0');

    let live = null;
    let lastSec = null;

    function updateTimerLogo(){
      const img  = $('#laiLogo');
      const text = $('#laiText');

      if(live && live.instLogo){       // 1) prioridad: logo de la institución
        img.src = live.instLogo;
        img.style.display = 'block';
        text.textContent = '';
      }else if(laiLogoUrl){            // 2) si no hay instLogo, usamos el LAI por URL
        img.src = laiLogoUrl;
        img.style.display = 'block';
        text.textContent = '';
      }else{                           // 3) si nada, texto "LAI"
        img.style.display = 'none';
        text.textContent = 'LAI';
      }
    }

    // RENDER ESTÁTICO
    function renderStatic(){
      if(!live) return;

      const inst = live.instName || '';
      const instCode = inst ? inst.slice(0,3).toUpperCase() : 'LAI';

      $('#laneBox').textContent = instCode;
      $('#presentInst').textContent = inst || 'INSTITUCIÓN';
      $('#presentName').textContent = live.athleteName || '';

      // Foto del atleta (izquierda). Si no hay, usamos logo institución.
      if(live.athletePhoto){
        $('#presentFlag').src = live.athletePhoto;
        $('#presentFlag').style.display = 'block';
      }else if(live.instLogo){
        $('#presentFlag').src = live.instLogo;
        $('#presentFlag').style.display = 'block';
      }else{
        $('#presentFlag').style.display = 'none';
      }

      // Logo institución (derecha)
      if(live.instLogo){
        $('#presentLogo').src = live.instLogo;
        $('#presentLogo').style.display = 'block';
      }else{
        $('#presentLogo').style.display = 'none';
      }

      const attemptNo = live.attemptNo || 1;
      const disc = (live.discipline || 'Snatch').toUpperCase();
      const w = live.declaredWeight ?? 0;

      $('#presentAttemptNo').textContent = attemptNo;
      $('#presentDiscipline').textContent = disc;
      $('#presentWeight').textContent = `${w} KG`;

      // Live bar
      $('#liveAttemptTag').textContent = `ATTEMPT ${attemptNo}`;
      $('#liveDisc').textContent = disc;
      $('#liveWeight').textContent = `${w} KG`;
      $('#liveNameMini').textContent = live.athleteName || '';

      // Timer logo
      updateTimerLogo();
    }

    // RENDER TIMER Y CAMBIO DE ESTADO
    function renderTimer(){
      if(!live) return;
      let ms = live.clockMs ?? 0;

      if(live.running && live.startedAt){
        ms = live.clockMs - (Date.now() - live.startedAt);
      }
      ms = Math.max(0, ms|0);
      const sec = Math.floor(ms/1000);

      if(sec !== lastSec){
        lastSec = sec;
        $('#timerBox').textContent = `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;
      }

      const running = !!live.running && ms > 0;

      if(running){
        $('#present').classList.remove('visible');
        $('#present').classList.add('hidden');
        $('#liveBar').classList.remove('hidden');
        $('#liveBar').classList.add('visible');
        $('#timerArea').classList.remove('hidden');
        $('#timerArea').classList.add('visible');
      }else{
        $('#present').classList.remove('hidden');
        $('#present').classList.add('visible');
        $('#liveBar').classList.remove('visible');
        $('#liveBar').classList.add('hidden');
        $('#timerArea').classList.remove('visible');
        $('#timerArea').classList.add('hidden');
      }
    }

    // SUSCRIPCIÓN A FIREBASE
    onValue(stateRef, snap=>{
      if(!snap.exists()) return;
      live = snap.val();
      renderStatic();
      renderTimer();
    });

    // Bucle suave para que el timer se vea corriendo también en Yolo
    function loop(){
      renderTimer();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
Fix athlete photo and timer logo
